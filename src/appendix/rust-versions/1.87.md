# Rust æ–°ç‰ˆè§£è¯» | 1.87 | åå‘¨å¹´ğŸ‰

[Rust 1.0](https://blog.rust-lang.org/2015/05/15/Rust-1.0/) åå‘¨å¹´ğŸ‰

> Rust 1.87 å®˜æ–¹ release doc: [Announcing Rust 1.87.0 | Rust Blog](https://blog.rust-lang.org/2025/05/15/Rust-1.87.0/)

é€šè¿‡ [rustup](https://www.rust-lang.org/tools/install) å®‰è£…çš„åŒå­¦å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å‡çº§åˆ° 1.87 ç‰ˆæœ¬:

```shell
$ rustup update stable
```

## åŒ¿åç®¡é“

1.87 ç‰ˆæœ¬ä¸ºæ ‡å‡†åº“æ·»åŠ äº†åŒ¿åç®¡é“æ”¯æŒï¼ŒåŒ…æ‹¬ä¸ `std::process::Command` è¾“å…¥/è¾“å‡ºæ–¹æ³•çš„é›†æˆã€‚ä¾‹å¦‚ï¼Œç°åœ¨å¯ä»¥ç›¸å¯¹ç®€å•åœ°åˆå¹¶æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯æµï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œè€Œè¿‡å»éœ€è¦é¢å¤–çº¿ç¨‹æˆ–å¹³å°ç‰¹å®šå‡½æ•°æ‰èƒ½å®ç°ã€‚

```rust
use std::process::Command;
use std::io::Read;

let (mut recv, send) = std::io::pipe()?;

let mut command = Command::new("path/to/bin")
    // æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯éƒ½ä¼šå†™å…¥åŒä¸€ä¸ªç®¡é“ï¼Œå®ç°åˆå¹¶
    .stdout(send.try_clone()?)
    .stderr(send)
    .spawn()?;

let mut output = Vec::new();
recv.read_to_end(&mut output)?;

// å¿…é¡»åœ¨è¿›ç¨‹é€€å‡ºå‰è¯»å–ç®¡é“å†…å®¹ï¼Œé¿å…ç¨‹åºè¾“å‡ºè¿‡å¤šæ—¶å¡«æ»¡ç³»ç»Ÿç¼“å†²åŒº
assert!(command.wait()?.success());
```

## å®‰å…¨çš„æ¶æ„å†…ç½®å‡½æ•°

å¤§å¤šæ•°ä»…å› éœ€è¦å¯ç”¨ç›®æ ‡ç‰¹æ€§è€Œè¢«æ ‡è®°ä¸ºä¸å®‰å…¨çš„ `std::arch` å†…ç½®å‡½æ•°ï¼Œç°åœ¨å¯ä»¥åœ¨å·²å¯ç”¨ç›¸åº”ç‰¹æ€§çš„å®‰å…¨ä»£ç ä¸­è°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ä½¿ç”¨æ‰‹åŠ¨å†…ç½®å‡½æ•°å®ç°æ•°ç»„æ±‚å’Œçš„ç¤ºä¾‹ç¨‹åºï¼Œç°åœ¨æ ¸å¿ƒå¾ªç¯å¯ä»¥ä½¿ç”¨å®‰å…¨ä»£ç ã€‚

```rust
#![forbid(unsafe_op_in_unsafe_fn)]

use std::arch::x86_64::*;

fn sum(slice: &[u32]) -> u32 {
    #[cfg(target_arch = "x86_64")]
    {
        if is_x86_feature_detected!("avx2") {
            // å®‰å…¨æ€§ï¼šæˆ‘ä»¬å·²æ£€æµ‹åˆ°è¿è¡Œæ—¶å¯ç”¨äº†è¯¥ç‰¹æ€§ï¼Œå› æ­¤è°ƒç”¨æ­¤å‡½æ•°æ˜¯å®‰å…¨çš„
            return unsafe { sum_avx2(slice) };
        }
    }

    slice.iter().sum()
}

#[target_feature(enable = "avx2")]
#[cfg(target_arch = "x86_64")]
fn sum_avx2(slice: &[u32]) -> u32 {
    // å®‰å…¨æ€§ï¼š__m256i å’Œ u32 å…·æœ‰ç›¸åŒçš„æœ‰æ•ˆæ€§
    let (prefix, middle, tail) = unsafe { slice.align_to::<__m256i>() };
    
    let mut sum = prefix.iter().sum::<u32>();
    sum += tail.iter().sum::<u32>();
    
    // åœ¨ 1.87 ä¸­æ ¸å¿ƒå¾ªç¯ç°åœ¨æ˜¯å®Œå…¨å®‰å…¨çš„ä»£ç ï¼Œå› ä¸ºå†…ç½®å‡½æ•°è¦æ±‚ä¸å‡½æ•°å®šä¹‰åŒ¹é…çš„ç›®æ ‡ç‰¹æ€§ (avx2)
    let mut base = _mm256_setzero_si256();
    for e in middle.iter() {
        base = _mm256_add_epi32(base, *e);
    }
    
    // å®‰å…¨æ€§ï¼š__m256i å’Œ u32 å…·æœ‰ç›¸åŒçš„æœ‰æ•ˆæ€§
    let base: [u32; 8] = unsafe { std::mem::transmute(base) };
    sum += base.iter().sum::<u32>();
    
    sum
}
```

## `asm!` è·³è½¬åˆ° Rust ä»£ç 

å†…è”æ±‡ç¼– (`asm!`) ç°åœ¨å¯ä»¥è·³è½¬åˆ° Rust ä»£ç ä¸­çš„ labeled ä»£ç å—ã€‚è¿™ä¸ºåº•å±‚ç¼–ç¨‹æä¾›äº†æ›´å¤§çµæ´»æ€§ï¼Œä¾‹å¦‚åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­å®ç°ä¼˜åŒ–æ§åˆ¶æµï¼Œæˆ–æ›´é«˜æ•ˆåœ°ä¸ç¡¬ä»¶äº¤äº’ã€‚

- `asm!` å®ç°åœ¨æ”¯æŒ label æ ‡ç­¾è¯­æ³•ï¼Œä½œä¸ºè·³è½¬ç›®æ ‡
- label å¿…é¡»æ˜¯è¿”å›ç±»å‹ä¸º `()` æˆ– `!` çš„å—è¡¨è¾¾å¼
- è·³è½¬æ—¶ä¼šæ‰§è¡Œè¯¥å—ï¼Œç„¶åç»§ç»­æ‰§è¡Œ `asm!` å—ä¹‹åçš„ä»£ç 
- åœ¨åŒä¸€ `asm!` é‡Œä½¿ç”¨è°ƒç”¨ä¸­ä½¿ç”¨ output å’Œ label ä»å¤„äº[unstable](https://github.com/rust-lang/rust/issues/119364)çš„

```rust
unsafe {
    asm!(
        "jmp {}",
        label {
            println!("ä»æ±‡ç¼–è·³è½¬è€Œæ¥ï¼");
        }
    );
}
```

æ›´å¤šç»†èŠ‚è¯·å‚é˜…[å‚è€ƒæ–‡æ¡£](https://doc.rust-lang.org/nightly/reference/inline-assembly.html#r-asm.operand-type.supported-operands.label)ã€‚

## ç‰¹å¾å®šä¹‰ä¸­ `impl Trait` çš„ç²¾ç¡®æ•è· (`+ use<...>`)

æœ¬ç‰ˆæœ¬ç¨³å®šäº†åœ¨ç‰¹å¾å®šä¹‰ä¸­ä½¿ç”¨ `impl Trait` è¿”å›ç±»å‹æ—¶æŒ‡å®šå…·ä½“æ•è·çš„æ³›å‹ç±»å‹å’Œç”Ÿå‘½å‘¨æœŸçš„åŠŸèƒ½ã€‚è¿™æ‰©å±•äº† [1.82](https://blog.rust-lang.org/2024/10/17/Rust-1.82.0/#precise-capturing-use-syntax) ç‰ˆæœ¬ä¸­å¯¹éç‰¹å¾å‡½æ•°çš„ç¨³å®šæ”¯æŒã€‚

ä¸€äº›ç¤ºä¾‹è§£è¯­æ³•ï¼š

```rust
trait Foo {
    fn method<'a>(&'a self) -> impl Sized;
    
    // ... è§£è¯­æ³•åç±»ä¼¼ï¼š
    type Implicit1<'a>: Sized;
    fn method_desugared<'a>(&'a self) -> Self::Implicit1<'a>;
    
    // ... è€Œä½¿ç”¨ç²¾ç¡®æ•è·æ—¶ ...
    fn precise<'a>(&'a self) -> impl Sized + use<Self>;
    
    // ... è§£è¯­æ³•åç±»ä¼¼ï¼š
    type Implicit2: Sized;
    fn precise_desugared<'a>(&'a self) -> Self::Implicit2;
}
```

## Others

å…¶å®ƒæ›´æ–°ç»†èŠ‚ï¼Œå’Œç¨³å®šçš„ API åˆ—è¡¨ï¼Œå‚è€ƒ[åŸBlog](https://blog.rust-lang.org/2025/05/15/Rust-1.87.0/#stabilized-apis)
